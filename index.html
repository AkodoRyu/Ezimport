<!DOCTYPE html>
<html lang=en>
<head>
	<meta charset=UTF-8>
	<meta name=viewport content="width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1.0">

	<title>Ezimport - Magento XML map and import platform</title>
	
	<!-- The framework -->
	<link rel=stylesheet href=css/inuit.css>
	<!-- Plugins -->
	<link rel=stylesheet href=css/grid.inuit.css>

	<link rel="stylesheet/less" type="text/css" href="css/styles.less">

	<script src="js/less.js" type="text/javascript"></script>	
	
	<link rel=stylesheet href=css/github.css>
	
	<!--[if lt IE 9]>
	<script src="js/html5.js"></script>
	<![endif]-->	

	<!--[if IE 6]>
    <link rel=stylesheet href="css/ie6.inuit.css">
	<![endif]-->
	<script type="text/javascript">

	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-27679031-1']);
	  _gaq.push(['_trackPageview']);

	  (function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();

	</script>
		
</head>

<body>

	<div id="fb-root"></div>
	<script>(function(d, s, id) {
	  var js, fjs = d.getElementsByTagName(s)[0];
	  if (d.getElementById(id)) return;
	  js = d.createElement(s); js.id = id;
	  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
	  fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));</script>

	<a class="github-ribbon" href="https://github.com/TweakIT/Ezimport"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub" /></a>
	
	<header class="wrapper header">

		<div class="grids">
		
			<div class="grid-16 grid">
				
				<h1 class="title"><span class="gold">Ez</span><span class="blue">import</span></h1>
				
				<h2>Ezimport is a simple Magento module that provides developers and shop owners with a platform which makes importing products from a lot of different XML files easier.</h2>
				
				<p><a href="https://github.com/TweakIT/Ezimport/zipball/master" class=button>Download .zip</a> <a href="https://github.com/TweakIT/Ezimport/tarball/master" class=button>Download .tar</a></p>

				<!-- Place this tag where you want the +1 button to render -->
				<g:plusone annotation="inline"></g:plusone>

				<!-- Place this render call where appropriate -->
				<script type="text/javascript">
				  (function() {
					var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
					po.src = 'https://apis.google.com/js/plusone.js';
					var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
				  })();
				</script>
				
				<div class="fb-like" data-href="http://tweakit.github.com/Ezimport" data-send="false" data-layout="button_count" data-width="450" data-show-faces="true"></div>
				
				<nav role=navigation>
					<ul class="nav">
						<li><a href=#overview title=""><span>Overview</span></a></li>
						<li><a href=#usage title=""><span>Usage</span></a></li>
						<li><a href=#under-the-hood title=""><span>Under the hood</span></a></li>
						<li><a href=#writing-tests title=""><span>Writing tests</span></a></li>						
						<li><a href=#about title=""><span>About</span></a></li>
						<li><a href=#comments title=""><span>Comments</span></a></li>
					</ul>
				</nav>
			
			</div>
			
		</div>
		
	</header>
			
	<article class="wrapper">

		<div class="grids">
		
			<div class="grid-16 grid">	

				<p class="message warning">This is an alpha release. Use at your own risk.</p>

				<h1 id=overview>Overview</h1>
				
				<p>Some retailers may have to deal with lots of wholesalers that all have their own XML markup. Ezimport lets you easily map the XML tags to your own attributes.</p>
				
				<p>You can also define custom behaviour for the conversion. For instance, a product in an XML file may have the following tag:</p>
				
				<p><pre>&lt;main_image>http://example.com/11dk2.jpg&lt;/main_image></pre></p>
				
				<p>Ezimport provides you with a platform that lets you define exactly what&#39;s going to happen with this XML tag when you import products from this XML. In fact, Ezimport already provides you with an attribute class that downloads the image to the server and tells the Magento product to use that image as its base image and thumbnail. This attribute is called &quot;Base image&quot;.</p>
			
			</div>
			
			<div class="grid-5 grid">
				<h2>Import your file</h2>
				<img src=img/add-xml.jpg />
			</div>
			
			<div class="grid-6 grid">
				<h2>Map XML tags</h2>
				<img src=img/mapper.jpg />
			</div>
			
			<div class="grid-5 grid">
				<h2>Import your products</h2>
				<img src=img/import.jpg />
			</div>
				
			<div class="grid-16 grid">
				
				<h1>Installation</h1>
				
				<p>Ezimport is currently not available as a Magento Connect PEAR channel community extension. The files in the &quot;src&quot; folder have to be manually copied to the Magento folder. After this, it&#39;s usually a good idea to renew the cache.</p>
				
				<h1 id=usage>Usage</h1>
				
				<h2>Step 1 - importing a XML file</h2>
				
				<p>Click the Ezimport menu button, find the &quot;add new XML&quot; button in the top right corner and add a XML file by giving the URL, uploading a file or directly copy/pasting the XML file contents on the webpage.</p>
				
				<h2>Step 2 - writing attribute classes</h2>
				
				<p>Create a new .php file in the /app/code/local/Tweakit/Ezimport/Helper/Attributes/ folder. Certain naming conventions must be followed: If you name your attribute &quot;color&quot; the file name must be &quot;color.php&quot; and the classname must be &quot;Tweakit_Ezimport_Helper_Attributes_Color&quot;.</p>
				
				<p>The class must implement the &quot;Tweakit_Ezimport_Helper_IAttribute&quot; interface and have the following public methods:</p>
				
				<ul>
					<li><pre class=php>getName()</pre></li>
					<li><pre class=php>getIdentifier()</pre></li>
					<li><pre class=php>getPreview($data)</pre></li>
					<li><pre class=php>getName(Mage_Catalog_Model_Product $product, $data)</pre></li>
				</ul>
					
				<p>The Baseimage attribute (Baseimage.php), for instance, looks something like this:</p>
				
				<pre class=php>
class Tweakit_Ezimport_Helper_Attributes_Baseimage implements Tweakit_Ezimport_Helper_IAttribute {

	public function getName() {
		return 'Base Image';	
	}
</pre>	
	<p>getName should return the name of the attribute. The name will be the label showed in the mapper, 
	so you know what to drag to this attribute.</p>
<pre class=php>
	public function getIdentifier() {
		return 'baseimage';	
	}
</pre>	
	<p>Should return an unique identifier of the attribute. The identifier of this attribute will 
	be associated with the XML tag and this pair is saved to the database.</p>
<pre class=php>
	public function getPreview($content) {
		return '&lt;image width="200px" src="'.$content.'" alt="'.$content.' (image not available)" />';
	}
</pre>	
	<p> This will return an HTML piece containing a preview of the value of the attribute. 
	This is used inside a table of the &quot;view products&quot; screen, before importing the products.
	In this case the image will be displayed instead of the URL. If the image isnt available, an 
	alternate text will be shown. If we wanted the URL to be shown, we would simply do 
	return &quot;$content&quot; without actually doing anything with the value.</p>
<pre class=php>
	public function setData(Mage_Catalog_Model_Product $product, $data) {
		
		//This array is needed for Magento to specify some details about the image
		$visibility = array (
			'thumbnail',
			'small_image',
			'image'
		);
		
		if($data) {
			
			//Download the image trough curl
			$ch = curl_init();
			curl_setopt ($ch, CURLOPT_URL, $data);
			curl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1);
			curl_setopt ($ch, CURLOPT_CONNECTTIMEOUT, 0);
			$fileContents = curl_exec($ch);
			$content_type = curl_getinfo($ch, CURLINFO_CONTENT_TYPE);
			curl_close($ch);
			
			if($content_type === 'image/jpeg') {
				
				$newImg = imagecreatefromstring($fileContents);
				
				//temporarily save the image with a random name
				$path = $filename = Mage::getBaseDir('tmp') . DS . 'ezimport' . DS . 'temp_img' . DS . md5( time() . rand(1,999)) . '.jpg';
				imagejpeg($newImg, $path, 100);
	
				//actually add the image to the product
				$product->addImageToMediaGallery ($filename, $visibility, true, false);
				
				//delete the temporarily image
				if(is_file($path))
					unlink($path);
			}

		}
</pre>	
	<p>This is the most important method. When a product gets imported, the setData method will 
	be called to set the data in the Magento product. We can do any transformation to the XML 
	value that we want, before it gets saved in the Magento product.</p>
<pre class=php>
	}
	
}</pre>
				<p><a target=_blank href="https://github.com/TweakIT/Ezimport/blob/master/src/app/code/local/Tweakit/Ezimport/Helper/Attributes/Baseimage.php">Click here to see this file in Github.</a>
				
				<p class="message info">After the setData method, the Magento product gets saved so there is no need to do this in the setData method.</p>

				<p>And thats all there is to it. Adding a file is enough. When mapping a XML, Ezimport will scan the Attributes folder and find your new attribute.</p>
				
				<h2>Step 3 - mapping attributes</h2>

				<p>After your attributes are configured, you can start mapping your XML&#39;s. Click map on the XML you wish to map. The blocks on the left represent the tags in the xml. Drag these to your attributes. You dont have to map al tags. And not all attributes have to have a tag. Click save when you are done</p>
			
				<img src=img/mapper2.jpg />

				<p class="message info">If you map the XML for a second time, the previous maps will be removed.</p>
				
				<h2>Step 4 - importing your products</h2>
				
				<p>You can now import the products into the Magento catalog. Keep in mind this is a work in progress, new features would be to select which products to import, into a catalog, manually edit some tags before importing, etc.</p>
				
				<p>You still have to configure the products before they appear in your shop. Adding a category, activating the product, adding some required data. etc.</p>
				
				<h1 id=under-the-hood>Under the hood</h1>
				
				<h2>General</h2>
				
				<p>Ezimport uses a XML page layout file for letting Magento know which blocks and templates to use. It can be found in <span class=dir>app/design/adminhtml/default/default/layout/ezimport.xml</span>. The templates can be found in <span class=dir>app/design/adminhtml/default/default/template/ezimport/</span>			.</p>
				
				<p>The main page uses the Mage_Adminhtml_Block_Widget_Container and Mage_Adminhtml_Block_Widget_Grid classes are used for displaying the XML entities. The rest is fairly straightforward usage of a combination of blocks and templates.</p>
				
				<h2>Models</h2>
				
				<p>Ezimport uses two models: maps, and sources. These are both non-EAV models as their attributes don&#39;t have to change during normal usage.</p>
				
				<img src=img/models.png />
				
				<p>A Map holds the relation between a XML product-tag and an attribute helper class.</p>
				
				<p>A Source is more complicated; besides holding the URL of the XML on the server, it has methods for converting the XML data. These methods will be described later in greater detail.</p>
				
				<h2>Adding XML&#39;s</h2>
				
				<p>The Tweakit_Ezimport_SourceController takes care of adding new XML&#39;s. The processNewXmlAction method receives post data and chooses what helper to load. There are currently three ways to make a new source: URL, file upload and direct input. Each way has its own helper. These helpers all extend Tweakit_Ezimport_Helper_Xml, which has methods for validating the XML and generating the filename.</p>
				
				<p>Once the XML is saved on the server, the Source can be configured with its new URL.</p>
				
				<p class="message info"><a href="http://php.net/manual/en/book.xmlreader.php" target=_blank title="PHP.net">XMLReader</a> is used to validate the XML.</p>
				
				<h2>Mapping XML&#39;s</h2>
				
				<p>The Tweakit_Ezimport_MapController class takes care of mapping XML&#39;s. Tweakit_Ezimport_Block_Map_Edit has two important methods: getDraggable and getDroppable.</p>
				
				<p>The getDraggable method returns an array of tags from a product in the XML. This is how it works: the getProductAttributes method of a Source model first parses the XML into an array  by using the Varien_Simplexml_Config class. It then uses PHP&#39;s <a href="http://php.net/manual/en/function.array-unique.php" target=_blank>array_unique</a> function to get all the attributes.</p>
				
				<p>The getDroppable method returns an array with all the attribute helper classes. The Tweakit_Ezimport_Helper_Attribute has a method called getAttributes. This method looks in the Helper/Attributes directory of Ezimport for php files. The classes in these files then get initialized. </p>
				
				<p class="message info">The edit maps screen uses jQuery&#39;s <a href="http://jqueryui.com/demos/draggable/" target=_blank>draggable</a> and <a href="http://jqueryui.com/demos/droppable/" target=_blank>droppable</a> plugins.</p>
				
				<p>When the user hits submit, a json datastructure will be send with POST containing the paired tags and attributes. These maps will get saved in the database.</p>

				<h2>Viewing and importing products</h2>
				
				<p>The Tweakit_Ezimport_SourceController class is, besides adding XML&#39;s, also responsible for viewing and importing products.</p>
				
				<p>The source model has a getMappedProductsArray method. This method returns an array with the XML tags mapped to the correct attribute.</p>
				
				<p>Lets say your XML looks like this:</p>
				
				<p><pre>
&lt;container>
	&lt;product>
		&lt;pname>MIONIX SAIPH 3200&lt;/pname>
		&lt;short_desc>Saiph got its name from the sixth brightest star in the constellation Orion.&lt;/short_desc>
		&lt;img_url>http://example.com/img/p/25-85.jpg&lt;/img_url>
		&lt;some_data>Lorem ipsum.&lt;/some_data>
	&lt;/product>
	&lt;product>
		&lt;pname>Coolbay HX&lt;/pname>
		&lt;short_desc>Chassis size type: Mid tower. Motherboard form factor: ATX, Micro ATX&lt;/short_desc>
		&lt;img_url>http://example.com/img/p/30-101.jpg&lt;/img_url>
		&lt;some_data>Lorem ipsum.&lt;/some_data>
	&lt;/product>
&lt;/container>
				</pre></p>
				
				<p>First, the method makes a conversion table like this:</p>
				
				<p><pre class=php>
Array	{
			["name"] 			=> "pname",
			["description"] 		=> "short_desc",
			["baseimage"]		=> "img_url"
		}				
				</pre></p>
				
				<p>Ezimport uses this conversion table to make the final array. </p>
				
				<p><pre class=php>$productscontainer = $this->getProductsContainer();</pre></p>
				
				<p>This method finds the product container in the XML. It looks for the second to last deepest nested tag and checks if there are more than one of these. This means that XML files that are structured as the follow example, can be recognized:</p>
				<p><pre class=xml>
&lt;xml>
	&lt;maincontainer>
		&lt;product_container>
		&lt;products>
			&lt;product>
				&lt;name>Lorem&lt;/name>
				&lt;description>Lorem&lt;/description>
			&lt;/product>

			&lt;product>
				&lt;name>Ipsum &lt;/name>
				&lt;description>Ipsum &lt;/description>
			&lt;/product>
		&lt;/products>
		&lt;product_container>
	&lt;/maincontainer>
&lt;/xml>
				</pre></p>
				
				<p>It does not matter how deep the main product container is nested.</p> 
				
				<p>However, the main problem with this approach is that products which have nested tags in them, can not properly be recognized.</p>
				
				<p>Unfortunately, the following XML currently fails:</p>
				<p><pre class=xml>				
&lt;products>
	&lt;product>
		&lt;name>Lorem&lt;/name>
		&lt;desicriptions>
			&lt;short_description>Lorem&lt;/short_description>
			&lt;long_description>Lorem&lt;/long_description>
			&lt;specification>Lorem&lt;/specification>
		&lt;/descriptions>
		&lt;packaging_info>
			&lt;length>10cm&lt;/length>
			&lt;width>20cm&lt;/width>
			&lt;weight>5kg&lt;/weight>
		&lt;/packaging_info>
&lt;/products>				
				</pre></p>				
				
				<h1 id=writing-tests>Writing tests</h1>
				
				<p>You can easily extend the standard Ezimport unit tests with your own XML&#39;s and/or attribute helper tests.</p>
				
				<h2>XML unit test</h2>
				
				<p>Coming soon.</p>
				
				<h2>Attribute helper unit test</h2>
				
				<p>Coming soon.</p>
				
				<h1 id=about>About</h1>
				
				<p>This project originated from a Dutch client. Later, it was decided to polish the module, make it open-source, and get some extra credit points for Uni :)</p>
				
				<p>Ezimport is released under the MIT License.</p>
				
				<p>You can contact me on <a href="https://twitter.com/#!/erfanimani" target=_blank>twitter</a> or by <a href="mailto:erfan@tweakit.eu" target=_blank>email</a>.</p>
				
				<h1 id=comments>Comments</h1>
				
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'ezimport'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>				
				
			</div>
			
			<div class="grid-16 grid">
				<a href="http://tweakit.eu/" target="_blank" class=logo>
					<img src="img/tweakit.png" alt="TweakIT" title="">
				</a>
			</div>			
			
		</div>

	</article>
	
	<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
	<script type="text/javascript" src="js/highlight.pack.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
		  $('pre').each(function(i, e) {hljs.highlightBlock(e, '    ')});
		});
	</script>

</body>
</html>